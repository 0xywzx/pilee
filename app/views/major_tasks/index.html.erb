<div class="task-list">
  <% if logged_in? %>
    <% if @user.major_tasks.any? %>
      <% @user.major_tasks.each do |major_task| %>
        <div class="task-box">
          <div class="task-box-header">
            <div class="major-task-name">
              <%= major_task.text %>
            </div>
            <div class="major-task-box-summary">20hr 2020/06/12 ~ 06/20</div>
          </div>
          <% MajorTask.find(major_task.id).sub_tasks.where("start_date <= ?", Date.today).each do |sub_task| %>
            <div class="sub-task-box">
              <div class="sub-task-title">
                <%= sub_task.text %>
              </div>
              <div class="sub-task-box-summary">
                <span>20hr    2020/06/12 ~ 06/20</span>
              </div>
              <div class="detail-task-box">
                <ul>
                  <% SubTask.find(sub_task.id).detail_tasks.each do |detail_task| %>
                    <li>
                      <div class="detail-task-item">
                        <div class="detail-task-name">
                          <%= detail_task.text %>
                        </div>
                        <div class="detail-task-summery">
                          <span style="vertical-align: sub;">1hr 2020/06/12<span>
                        </div>
                      </div>
                    </li>
                  <% end %>
                </ul>
                <div style="display: flex; justify-content: flex-end;">
                  <button class="add_button" id="showDetailTaskForm<%= sub_task.id %>"
                    onClick='showDetailTaskForm(<%= sub_task.id %>)'>+</button>
                </div>
                <div id="detailTaskForm<%= sub_task.id %>" style="display: none;">
                  <%= form_for :detail_task, url: sub_task_detail_tasks_path(sub_task) do |form| %>
                    <div>
                      <%= form.text_area :text, placeholder: '小タスク', class: "detail-task-text-input", rows: "3" %>
                    </div>
                    <div class="detal-task-option-field">
                      <div>
                        <%= form.date_field :date, class: "detail-task-date-input" %>
                      </div>
                      <div>
                        <button class="hide_button" id="hideDetailTaskForm<%= sub_task.id %>" style="display: none;" type="button"
                          onClick='hideDetailTaskForm(<%= sub_task.id %>)'>x</button>
                        <%= form.submit "追加", class: "add-detail-task-button" %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
          <button class="show-sub-task-button" id="showSubTaskForm<%= major_task.id%>" type="button"
            onClick='showSubTaskForm(<%= major_task.id %>)'>タスクを追加</button>
          <div>
            <div id='subTaskForm<%= major_task.id %>' style='display: none;'>
              <%= form_for ([MajorTask.find(major_task.id), MajorTask.find(major_task.id).sub_tasks.build]) do |form| %>
                <%= form.text_area :text, placeholder: '中タスク', class: "sub-task-text-input", rows: "3" %>
                <div class="sub-task-option-field">
                  <div><%= form.date_field :start_date, class: "sub-task-date-input" %></div>
                  <div>~</div>
                  <div><%= form.date_field :end_date, class: "sub-task-date-input" %></div>
                </div>
                <div class="sub-task-button-field">
                  <button class="hide_button" id="hideSubTaskForm<%= major_task.id %>" style="display: none;" type="button"
                    onClick='hideSubTask(<%= major_task.id %>)'>✖️</button>
                  <%= form.submit "追加", class: "add-task-button" %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>
    <div class="add-major-task-field">
      <button class="show-sub-task-button" id="showMajorTaskForm" type="button" style="margin-top: 8px;"
        onClick='showMajorTaskForm()'>タスクを追加</button>
      <div class="" id="majorTaskForm" style='display: none;'>
        <%= form_for :major_task, url: user_major_tasks_path(@user) do |form| %>
          <%= form.text_area :text, placeholder: '大タスク', class: "sub-task-text-input", rows: "3" %>
          <div class="sub-task-option-field">
            <div><%= form.date_field :start_date, class: "sub-task-date-input" %></div>
            <div>~</div>
            <div><%= form.date_field :end_date, class: "sub-task-date-input" %></div>
          </div>
          <div class="sub-task-button-field">
            <%= form.submit "追加", class: "add-task-button" %>
          </div>
        <% end %>
            <button class="hide_button" id="hideMajorTaskForm" style="display: none;" type="button"
              onClick='hideMajorTaskForm()'>✖️</button>
      </div>
    </div>
  <% end %>
</div>

<div class="day-task-box">
  <span id="date1"></span>
  <% if logged_in? %>
    <% if @sub_task_list_today.any? %>
      <% @sub_task_list_today.each_with_index do |sub_task_today, i| %>
        <% if i > 0 && @sub_task_list_today[i-1].major_task_id != @sub_task_list_today[i].major_task_id %>
          <p><%= MajorTask.find(@sub_task_list_today[i].major_task_id).text %></p>
        <% else %>
          <% if i == 0 %>
            <p><%= MajorTask.find(@sub_task_list_today[i].major_task_id).text %></p>
          <% end %>
        <% end %>
        
      <% end %>
    <% end %>
  <% end %>
</div>
<br/>
<h1>TODOアプリ</h1>
<% if logged_in? %>

  <h2>タスク一覧</h2>
  <%= link_to "ログアウト", logout_path, method: :delete %> 
  <% if @user.major_tasks.any? %>
    <% @user.major_tasks.each do |major_task| %>
      <div>
        <div class='major-task-field' style="display: inline-block; vertical-align: top;">
          <%= major_task.text %>
          <input id="showSubTaskForm<%= major_task.id%>" type="button" value="+"
            onClick='showSubTaskForm(<%= major_task.id %>)'>
          <input id="hideSubTaskForm<%= major_task.id %>" style="display: none;" type="button" value="x"
            onClick='hideSubTask(<%= major_task.id %>)'>
        </div>
        <div style="display: inline-block; vertical-align: top;">
          <% MajorTask.find(major_task.id).sub_tasks.each do |sub_task| %>
            <div>
              <div class='sub-task-field' style="display: inline-block; vertical-align: top;">
                <%= sub_task.text %>
                <input id="showDetailTaskForm<%= sub_task.id %>" type="button" value="+"
                  onClick='showDetailTaskForm(<%= sub_task.id %>)'>
                <input id="hideDetailTaskForm<%= sub_task.id %>" style="display: none;" type="button" value="x"
                  onClick='hideDetailTaskForm(<%= sub_task.id %>)'>
              </div>
              <div class='detail-task-field' style="display: inline-block; vertical-align: top;">
                <% SubTask.find(sub_task.id).detail_tasks.each do |detail_task| %>
                  <p><%= detail_task.text %></p>
                <% end %>
                <div id="detailTaskForm<%= sub_task.id %>" style="display: none;">
                  <%= form_for :detail_task, url: sub_task_detail_tasks_path(sub_task) do |f| %>
                    <p>
                      <%= f.text_field :text, placeholder: '小タスク' %>
                    </p>
                    <p>
                      <%= f.date_field :date %>
                    </p>
                    <p>
                      <%= f.number_field :time_duration %>
                    </p>
                    <p>
                      <%= f.submit %>
                    </p>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
          <div id='subTaskForm<%= major_task.id %>' style='display: none;'>
            <%= form_for ([MajorTask.find(major_task.id), MajorTask.find(major_task.id).sub_tasks.build]) do |f| %>
              <p>
                <%= f.text_field :text, placeholder: '中タスク' %>
              </p>
              <p>
                <%= f.date_field :start_date %>
              </p>
              <p>
                <%= f.date_field :end_date %>
              </p>
              <p>
                <%= f.number_field :time_duration %>
              </p>
              <p>
                <%= f.submit %>
              </p>
            <% end %>
          </div>
        </div>
        </div>
      </div>  
    <% end %>
  <% end %>
  <%= form_for ([@user, @user.major_tasks.build]) do |f| %>
    <p>
      <%= f.text_field :text, placeholder: '大タスク' %>
    </p>
    <p>
      <%= f.date_field :start_date %>
    </p>
    <p>
      <%= f.date_field :end_date %>
    </p>
    <p>
      <%= f.number_field :time_duration %>
    </p>
    <p>
      <%= f.submit %>
    </p>
  <% end %>
<% else %>
  <p>タスクの管理ができるアプリです。まずはSign up / ログインをしてください。</p>
  <%= link_to "Sign up", new_user_path %>
  <%= link_to "ログイン", login_path%>
<% end %>
<h1>振り返り</h1>
<div class="day-task-box" style="display: inline-block; vertical-align: top;">
  <span id="date1"></span>
  <% if logged_in? %>
    <% if @sub_task_list_today.any? %>
      <div class="major_task_box">
        <span><%= @sub_task_list_today[0].major_task_id %></span>
        <% @sub_task_list_today.each_with_index do |sub_task_today, i| %>
          <% if i == 0 || @sub_task_list_today[i-1].major_task_id == @sub_task_list_today[i].major_task_id %>
            <% if @sub_task_list_today[i-1].major_task_id == @sub_task_list_today[i].major_task_id %>
              <p><%= MajorTask.find(@sub_task_list_today[i].major_task_id).text %></p>
            <% end %>
          <% else %>
            <p><%= MajorTask.find(@sub_task_list_today[i].major_task_id).text %></p>
          <% end %>
          <div class="sub-task-box-day">
            <p><%= sub_task_today.text %></p>
            <ul>
              <% SubTask.find(sub_task_today.id).detail_tasks.each do |detail_task_day| %>
                <li><%= detail_task_day.text %></li>
              <% end %>
              <input id="showDetailTaskFormDayButton<%= sub_task_today.id %>" type="button" value="やったことを追加"
                onClick='showDetailTaskFormDay(<%= sub_task_today.id %>)'>
              <div id='detailTaskFormDay<%= sub_task_today.id %>' style='display: none;'>
                <%= form_for ([SubTask.find(sub_task_today.id), SubTask.find(sub_task_today.id).detail_tasks.build]) do |f| %>
                  <span>
                    <%= f.text_field :text, placeholder: 'やったこと' %>
                    <%= f.number_field :time_duration %>
                  </span>
                  <span>
                    <%= f.submit %>
                  </span>
                <% end %>
                <input id="hideDetailTaskFormDayButton<%= sub_task_today.id %>" type="button" value="✖️"
                  onClick='hideDetailTaskFormDay(<%= sub_task_today.id %>)'>
              </div>
            </ul>
          </div>
        <% end %>
      </div>
    <% end %>
  <% end %>
</div>
  


<script> 
  var now = new Date();
  var year = now.getFullYear();
  var month = now.getMonth()+1; 
  var date = now.getDate();
  var day = now.getDay(); 

  document.getElementById("date").innerHTML = getToday() 
  function getToday() {
  	var day_of_the_week = new Array("日","月","火","水","木","金","土");
    var today = month + "/" + date + "日(" + day_of_the_week[day] + ")"; 

    for (let i = 1; i <= 2; i++ ) {
      date = date + 1
      document.getElementById("date"+i).innerHTML = month + "/" + date + "日(" + day_of_the_week[day] + ")";
    }
    return today;
  }
  
  function showMajorTaskForm() {
    document.getElementById('majorTaskForm').style.display = 'inline-block'; 
    document.getElementById('showMajorTaskForm').style.display = 'none';
    document.getElementById('hideMajorTaskForm').style.display = 'inline-block';
  }

  function hideMajorTaskForm() {
    document.getElementById('majorTaskForm').style.display = 'none';
    document.getElementById('showMajorTaskForm').style.display = 'inline-block';
    document.getElementById('hideMajorTaskForm').style.display = 'none';
  }

  function showSubTaskForm(majorTaskId) {
    document.getElementById('subTaskForm' + majorTaskId).style.display = 'inline-block'; 
    document.getElementById('showSubTaskForm' + majorTaskId).style.display = 'none';
    document.getElementById('hideSubTaskForm' + majorTaskId).style.display = 'inline-block';
  }

  function hideSubTask(majorTaskId) {
    document.getElementById('subTaskForm' + majorTaskId).style.display = 'none';
    document.getElementById('showSubTaskForm' + majorTaskId).style.display = 'inline-block';
    document.getElementById('hideSubTaskForm' + majorTaskId).style.display = 'none';
  }

  function showDetailTaskForm(subTaskId) {
    document.getElementById('detailTaskForm' + subTaskId).style.display = 'inline-block'; 
    document.getElementById('showDetailTaskForm' + subTaskId).style.display = 'none';
    document.getElementById('hideDetailTaskForm' + subTaskId).style.display = 'inline-block';
  }

  function hideDetailTaskForm(subTaskId) {
    document.getElementById('detailTaskForm' + subTaskId).style.display = 'none';
    document.getElementById('showDetailTaskForm' + subTaskId).style.display = 'inline-block';
    document.getElementById('hideDetailTaskForm' + subTaskId).style.display = 'none';
  }

  function showDetailTaskFormDay(subTaskId) {
    document.getElementById('detailTaskFormDay' + subTaskId).style.display = 'inline-block'; 
    document.getElementById('showDetailTaskFormDayButton' + subTaskId).style.display = 'none';
    document.getElementById('hideDetailTaskFormDayButton' + subTaskId).style.display = 'inline-block';
  }

  function hideDetailTaskFormDay(subTaskId) {
    document.getElementById('detailTaskFormDay' + subTaskId).style.display = 'none';
    document.getElementById('showDetailTaskFormDayButton' + subTaskId).style.display = 'inline-block';
    document.getElementById('hideDetailTaskFormDayButton' + subTaskId).style.display = 'none';
  }

</script>